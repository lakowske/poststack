<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.0.xsd">

    <!-- Initial schema for Poststack v1.0 -->
    
    <changeSet id="001-create-poststack-schema" author="poststack">
        <createSchema schemaName="poststack"/>
        <rollback>
            <dropSchema schemaName="poststack"/>
        </rollback>
    </changeSet>

    <changeSet id="002-create-system-info-table" author="poststack">
        <createTable schemaName="poststack" tableName="system_info">
            <column name="id" type="serial" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="key" type="varchar(255)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="value" type="text"/>
            <column name="created_at" type="timestamp" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="timestamp" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <rollback>
            <dropTable schemaName="poststack" tableName="system_info"/>
        </rollback>
    </changeSet>

    <changeSet id="003-create-services-table" author="poststack">
        <createTable schemaName="poststack" tableName="services">
            <column name="id" type="serial" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="varchar(255)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="type" type="varchar(100)">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="varchar(50)" defaultValue="stopped">
                <constraints nullable="false"/>
            </column>
            <column name="config" type="jsonb"/>
            <column name="created_at" type="timestamp" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="timestamp" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <rollback>
            <dropTable schemaName="poststack" tableName="services"/>
        </rollback>
    </changeSet>

    <changeSet id="004-create-containers-table" author="poststack">
        <createTable schemaName="poststack" tableName="containers">
            <column name="id" type="serial" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="service_id" type="integer">
                <constraints nullable="false" 
                            foreignKeyName="fk_containers_service_id" 
                            references="poststack.services(id)" 
                            deleteCascade="true"/>
            </column>
            <column name="container_id" type="varchar(255)">
                <constraints unique="true"/>
            </column>
            <column name="image" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="varchar(50)" defaultValue="created">
                <constraints nullable="false"/>
            </column>
            <column name="config" type="jsonb"/>
            <column name="created_at" type="timestamp" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="timestamp" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <rollback>
            <dropTable schemaName="poststack" tableName="containers"/>
        </rollback>
    </changeSet>

    <changeSet id="005-create-certificates-table" author="poststack">
        <createTable schemaName="poststack" tableName="certificates">
            <column name="id" type="serial" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="domain" type="varchar(255)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="status" type="varchar(50)" defaultValue="pending">
                <constraints nullable="false"/>
            </column>
            <column name="cert_path" type="text"/>
            <column name="key_path" type="text"/>
            <column name="expires_at" type="timestamp"/>
            <column name="created_at" type="timestamp" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="timestamp" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <rollback>
            <dropTable schemaName="poststack" tableName="certificates"/>
        </rollback>
    </changeSet>

    <changeSet id="006-create-users-table" author="poststack">
        <createTable schemaName="poststack" tableName="users">
            <column name="id" type="serial" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="username" type="varchar(100)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="email" type="varchar(255)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="email_verified" type="boolean" defaultValue="false">
                <constraints nullable="false"/>
            </column>
            <column name="password_hash" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="hash_algorithm" type="varchar(50)" defaultValue="SHA512-CRYPT">
                <constraints nullable="false"/>
            </column>
            <column name="active" type="boolean" defaultValue="true">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="timestamp" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="timestamp" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="last_login_at" type="timestamp"/>
            <column name="failed_login_attempts" type="integer" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="locked_until" type="timestamp"/>
            <column name="password_expires_at" type="timestamp"/>
            <column name="password_reset_token" type="varchar(255)">
                <constraints unique="true"/>
            </column>
            <column name="password_reset_expires_at" type="timestamp"/>
            <column name="two_factor_enabled" type="boolean" defaultValue="false">
                <constraints nullable="false"/>
            </column>
            <column name="two_factor_secret" type="varchar(255)"/>
            <column name="metadata" type="jsonb"/>
        </createTable>
        <rollback>
            <dropTable schemaName="poststack" tableName="users"/>
        </rollback>
    </changeSet>

</databaseChangeLog>